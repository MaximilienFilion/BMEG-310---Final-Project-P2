x = "Cluster",
y = "Age (years)"
) +
theme_minimal(base_size = 14) +
theme(legend.position = "none")
anova_ward_d2_plot <- ggplot(merged_data, aes(x = clusters_ward_D2, y = AGE, fill = clusters_ward_D2)) +
geom_boxplot() +
labs(
title = "Patient Age Distribution Across Ward.D2 Clusters",
x = "Cluster",
y = "Age (years)"
) +
theme_minimal(base_size = 14) +
theme(legend.position = "none")
# Plot
anova_ward_d1_plot
anova_ward_d2_plot
# Save
ggsave("AgeDistributionAcrossClusters_WardD1.png", anova_ward_d1_plot, width=7, height=3, dpi=300)
ggsave("AgeDistributionAcrossClusters_WardD2.png", anova_ward_d2_plot, width=7, height=3, dpi=300)
# Tumor stage
merged_data$AJCC_PATHOLOGIC_TUMOR_STAGE <- as.factor(merged_data$AJCC_PATHOLOGIC_TUMOR_STAGE)
# Contingency table
table_stage_cluster_wardd1 <- table(merged_data$clusters_ward_D1, merged_data$AJCC_PATHOLOGIC_TUMOR_STAGE)
table_stage_cluster_wardd1
table_stage_cluster_wardd2 <- table(merged_data$clusters_ward_D2, merged_data$AJCC_PATHOLOGIC_TUMOR_STAGE)
table_stage_cluster_wardd2
# Chi-square Test
chisq_test_wardd1 <- chisq.test(table_stage_cluster_wardd1)
chisq_test_wardd1
chisq_test_wardd2 <- chisq.test(table_stage_cluster_wardd2)
chisq_test_wardd2
# Visualization
chi_test_plot_ward1 <- ggplot(merged_data, aes(x = clusters_ward_D1, fill = AJCC_PATHOLOGIC_TUMOR_STAGE)) +
geom_bar(position = "fill") +  # fill = proportion per cluster
ylab("Proportion") +
xlab("Cluster") +
labs(title = "Distribution of Tumor Stage Across Ward.D1 Clusters") +
theme_minimal(base_size = 14)
chi_test_plot_ward2 <- ggplot(merged_data, aes(x = clusters_ward_D2, fill = AJCC_PATHOLOGIC_TUMOR_STAGE)) +
geom_bar(position = "fill") +  # fill = proportion per cluster
ylab("Proportion") +
xlab("Cluster") +
labs(title = "Distribution of Tumor Stage Across Ward.D2 Clusters") +
theme_minimal(base_size = 14)
#plot
chi_test_plot_ward1
chi_test_plot_ward2
#save
ggsave("TumorStageAcrossClusters_WardD1.png",chi_test_plot_ward1 , width=4, height=4, dpi=300)
ggsave("TumorStageAcrossClusters_WardD2.png",chi_test_plot_ward2 , width=4, height=4, dpi=300)
# Function: fisher_test_genes(gene1, gene2, gene_patient_matrix)
# Inputs: Two gene names and mutation matrix
# Outputs: Odds ratio, p-value, relationship type
# Function: fisher_test_genes(gene1, gene2, gene_patient_matrix)
fisher_test_genes <- function(gene1, gene2, gene_patient_matrix) {
g1 <- gene_patient_matrix[, gene1]
g2 <- gene_patient_matrix[, gene2]
# Build 2x2 contingency table
contingency <- table(g1, g2)
# Skip genes with insufficient combinations
if (!all(dim(contingency) == c(2, 2))) {
return(list(odds_ratio = NA, p_value = NA, relationship = "Insufficient data"))
}
test <- fisher.test(contingency)
#odds_ratio <- test$estimate
odds_ratio <- unname(test$estimate)
p_val <- test$p.value
relationship <- ifelse(
is.na(odds_ratio),
"Insufficient data",
ifelse(odds_ratio > 1, "Co-mutation",
ifelse(odds_ratio < 1, "Mutual exclusivity", "No association"))
)
return(list(odds_ratio = odds_ratio, p_value = p_val, relationship = relationship))
}
# Get top 20 genes from Investigation 1
top20_gene_names <- top_20_genes$Hugo_Symbol
#matrix has patients as columns and genes as rows. Transpose matrix for fischer
t_gene_patient_matrix <- t(gene_patient_matrix)
t_gene_patient_matrix <- as.data.frame(t_gene_patient_matrix)
colnames(t_gene_patient_matrix)[1:20]
valid_genes <- intersect(top20_gene_names, colnames(t_gene_patient_matrix))
valid_genes
# Generate all pairwise combinations (190 pairs)
pairs <- combn(valid_genes, 2, simplify = FALSE)
# Apply Fisher's exact test to each pair
# Store results in dataframe: gene1, gene2, odds_ratio, p_value
results <- data.frame()
for (pair in pairs) {
g1 <- pair[1]
g2 <- pair[2]
res <- fisher_test_genes(g1, g2, t_gene_patient_matrix)
results <- rbind(
results,
data.frame(
Gene1 = g1,
Gene2 = g2,
OR = res$odds_ratio,
p_value = res$p_value,
relationship_raw = res$relationship
)
)
}
results
# Apply Bonferroni correction
results$p_adjust_bonf <- p.adjust(results$p_value, method = "bonferroni")
# decided to use Benjamini-Hochberg - explained in paper
# OR apply Benjamini-Hochberg FDR correction
results$p_adjust_fdr <- p.adjust(results$p_value, method = "BH")
# Filter for significant pairs (adjusted p-value < 0.05)
results_signif <- subset(results, p_adjust_bonf < 0.05)
results
# Co-mutation: Odds ratio > 1 and significant p-value
# [INSERT CODE HERE]
# Mutual exclusivity: Odds ratio < 1 and significant p-value
# [INSERT CODE HERE]
# Sort and display top co-mutating pairs
# [INSERT CODE HERE]
# Sort and display top mutually exclusive pairs
# [INSERT CODE HERE]
#since none are significant, should I examine pairs with the lowest uncorrected p-values or most extreme odds ratios?
# Create heatmap of odds ratios for top 20 genes
# [INSERT CODE HERE]
# Create network diagram showing significant relationships
# Nodes = genes, Edges = significant co-mutation/exclusivity
# Color edges by relationship type
# [INSERT CODE HERE]
# Create co-occurrence matrix
# [INSERT CODE HERE]
library(survival) # Does the Kaplan-Meier curves and Cox Regression
library(survminer) # Makes survival plots
# Get the top 20 genes
top_20_gene_names <- top_20_genes$Hugo_Symbol
# Initialize results dataframe
# Creates and empty dataframe to store results
gene_dss_results <- data.frame(
Gene = character(),
Mutated_Patients = integer(),
Non_Mutated_Patients = integer(),
Hazard_Ratio = numeric(),
CI_Lower = numeric(),
CI_Upper = numeric(),
P_Value = numeric(),
Log_Rank_P = numeric(),
stringsAsFactors = FALSE
)
# Create a list to store survival plots
survival_plots_list <- list()
# Loop through each of the top 20 genes
for (gene in top_20_gene_names) {
# Get mutation status for this gene across common patients
gene_mutations <- gene_patient_matrix[gene, ]
# Create a temporary dataframe matching patients
temp_df <- data.frame(
PATIENT_ID = names(gene_mutations),
Gene_Mutated = as.numeric(gene_mutations),
stringsAsFactors = FALSE
)
# Merge with clinical data (Joins mutation statue with clincal survival data)
merged_data <- merge(
data_clinical_patient,
temp_df,
by = "PATIENT_ID",
all.x = FALSE
)
# Remove rows with missing DSS data
merged_data <- merged_data[!is.na(merged_data$DSS_MONTHS) &
!is.na(merged_data$DSS_STATUS), ]
# Count patients in each group
n_mutated <- sum(merged_data$Gene_Mutated == 1) #How many have the mutation
n_non_mutated <- sum(merged_data$Gene_Mutated == 0)#How many don't
# Skip if too few patients in either group (Can't do reliable statistics with tiny groups)
if (n_mutated < 3 || n_non_mutated < 3) {
next
}
# Create survival object for DSS
surv_dss <- Surv(
time = merged_data$DSS_MONTHS,
event = 1 - merged_data$DSS_STATUS  # Convert to event (1 = death)
)
# Fit Kaplan-Meier model (changes 0 -> Non-mutated & 1 -> mutated)
merged_data$Gene_Status <- factor(
merged_data$Gene_Mutated,
levels = c(0, 1),
labels = c("Non-Mutated", "Mutated")
)
fit_km <- survfit(surv_dss ~ Gene_Status, data = merged_data)
# Perform log-rank test
log_rank_test <- survdiff(surv_dss ~ Gene_Status, data = merged_data)
log_rank_p <- pchisq(log_rank_test$chisq,
length(log_rank_test$n) - 1,
lower.tail = FALSE)
# Fit Cox proportional hazards model
cox_model <- coxph(surv_dss ~ Gene_Mutated, data = merged_data)
cox_summary <- summary(cox_model)
# Extract hazard ratio and confidence interval
hr <- cox_summary$conf.int[1, 1] # Hazard Ratio -> 2.35 =  2.35x higher risk
ci_lower <- cox_summary$conf.int[1, 3] # 95% confidence upper bound
ci_upper <- cox_summary$conf.int[1, 4] # 95% confidence lower bound
cox_p <- cox_summary$coefficients[1, 5] # P-value from Cox model
# Store results
gene_dss_results <- rbind(gene_dss_results, data.frame(
Gene = gene,
Mutated_Patients = n_mutated,
Non_Mutated_Patients = n_non_mutated,
Hazard_Ratio = hr,
CI_Lower = ci_lower,
CI_Upper = ci_upper,
P_Value = cox_p,
Log_Rank_P = log_rank_p,
stringsAsFactors = FALSE
))
# Create and store survival plot for significant genes (p < 0.05)
if (log_rank_p < 0.05) {
plot_obj <- ggsurvplot(
fit_km,
data = merged_data,
pval = TRUE,
conf.int = TRUE,
risk.table = TRUE,
palette = c("blue", "red"),
title = paste0("DSS for ", gene, " Mutation"),
xlab = "Time (Months)",
ylab = "Disease-Specific Survival Probability",
legend.labs = c("Non-Mutated", "Mutated"),
ggtheme = theme_minimal(base_size = 12)
)
survival_plots_list[[gene]] <- plot_obj
}
}
# Display results sorted by p-value
gene_dss_results <- gene_dss_results[order(gene_dss_results$P_Value), ]
print(gene_dss_results)
# Apply Bonferroni correction
gene_dss_results$P_Value_Bonferroni <- p.adjust(
gene_dss_results$P_Value,
method = "bonferroni"
)
# Apply Benjamini-Hochberg FDR correction
gene_dss_results$P_Value_FDR <- p.adjust(
gene_dss_results$P_Value,
method = "fdr"
)
# Summary of results
cat("\nMULTIPLE TESTING CORRECTION RESULTS\n\n")
# Count significant genes at different thresholds
n_nominal <- sum(gene_dss_results$P_Value < 0.05)
n_fdr <- sum(gene_dss_results$P_Value_FDR < 0.05)
n_bonf <- sum(gene_dss_results$P_Value_Bonferroni < 0.05)
cat("Genes significant BEFORE correction (p < 0.05):", n_nominal, "\n")
cat("Genes significant AFTER FDR correction (p < 0.05):", n_fdr, "\n")
cat("Genes significant AFTER Bonferroni correction (p < 0.05):", n_bonf, "\n\n")
# Show top 5 candidate genes
cat("TOP 5 CANDIDATE GENES (Ranked by P-Value) \n\n")
top5 <- head(gene_dss_results[, c("Gene", "Mutated_Patients", "Hazard_Ratio",
"P_Value", "P_Value_FDR", "P_Value_Bonferroni")], 5)
print(top5, row.names = FALSE)
# If any genes passed FDR correction, show them
if (n_fdr > 0) {
cat("\n GENES PASSING FDR CORRECTION\n\n")
significant_genes_fdr <- gene_dss_results[gene_dss_results$P_Value_FDR < 0.05,
c("Gene", "Hazard_Ratio", "P_Value", "P_Value_FDR")]
print(significant_genes_fdr, row.names = FALSE)
} else {
cat("\n*** No genes reached statistical significance after FDR correction ***\n")
cat("This suggests that while some genes show suggestive associations,\n")
cat("the evidence is not strong enough to confidently rule out chance findings.\n")
}
# Interpretation note for nominally significant genes
if (n_nominal > 0 & n_fdr == 0) {
cat("\nINTERPRETATION \n")
cat("Although", n_nominal, "gene(s) showed p < 0.05 before correction,\n")
cat("none survived multiple testing correction. This means:\n")
cat("1. These associations may be worth investigating in larger studies\n")
cat("2. They should be considered hypothesis-generating, not confirmed\n")
cat("3. Larger sample sizes may be needed to detect true effects\n")
}
library(ggplot2)
# Create forest plot of hazard ratios with confidence intervals
gene_dss_results$Gene <- factor(
gene_dss_results$Gene,
levels = gene_dss_results$Gene[order(gene_dss_results$Hazard_Ratio)]
)
# Add significance marker
gene_dss_results$Significant <- ifelse(
gene_dss_results$P_Value_FDR < 0.05,
"Significant (FDR < 0.05)",
"Not Significant"
)
# Forest plot
forest_plot <- ggplot(gene_dss_results,
aes(x = Hazard_Ratio, y = Gene, color = Significant)) +
geom_point(size = 3) +
geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper), height = 0.3) +
geom_vline(xintercept = 1, linetype = "dashed", color = "black") +
scale_color_manual(values = c("Significant (FDR < 0.05)" = "red",
"Not Significant" = "grey60")) +
labs(
title = "Forest Plot: Hazard Ratios for Disease-Specific Survival",
subtitle = "Top 20 Mutated Genes in KIRC",
x = "Hazard Ratio (95% CI)",
y = "Gene",
color = "Significance"
) +
theme_minimal(base_size = 12) +
theme(
plot.title = element_text(hjust = 0.5, face = "bold"),
plot.subtitle = element_text(hjust = 0.5),
legend.position = "bottom"
)
print(forest_plot)
# Create comprehensive summary table
summary_table <- gene_dss_results[, c("Gene", "Mutated_Patients",
"Hazard_Ratio", "CI_Lower", "CI_Upper",
"P_Value", "P_Value_FDR")]
summary_table$HR_95CI <- sprintf("%.2f (%.2f-%.2f)",
summary_table$Hazard_Ratio,
summary_table$CI_Lower,
summary_table$CI_Upper)
# Round numeric columns
summary_table$P_Value <- format.pval(summary_table$P_Value, digits = 3)
summary_table$P_Value_FDR <- format.pval(summary_table$P_Value_FDR, digits = 3)
# Select final columns
final_table <- summary_table[, c("Gene", "Mutated_Patients", "HR_95CI",
"P_Value", "P_Value_FDR")]
colnames(final_table) <- c("Gene", "N Mutated", "HR (95% CI)",
"P-Value", "Adjusted P (FDR)")
cat("\n=== Summary Table: Gene Mutations and Disease-Specific Survival ===\n")
print(final_table, row.names = FALSE)
# Display survival plots for significant genes
if (length(survival_plots_list) > 0) {
cat("\n=== Kaplan-Meier Curves for Significant Genes ===\n")
for (gene_name in names(survival_plots_list)) {
print(survival_plots_list[[gene_name]])
}
}
#I'm not sure if this section makes sense. I don't know if I did the analysis right here. Another set of eyes would be great here.
synonymous_types <- c("Silent")
non_synonymous_types <- c(
"Missense_Mutation",
"Nonsense_Mutation",
"Frame_Shift_Del",
"Frame_Shift_Ins",
"Splice_Site",
"In_Frame_Del",
"In_Frame_Ins",
"Translation_Start_Site",
"Nonstop_Mutation"
)
# Initialize results for mutation type analysis
mutation_type_results <- data.frame(
Gene = character(),
N_Synonymous = integer(),
N_NonSynonymous = integer(),
N_NoMutation = integer(),
P_Value_Overall = numeric(),
stringsAsFactors = FALSE
)
# We need to use the full mutations dataset (not just non_synonymous_dataset) because we need to find synonymous mutations too
all_mutations_common <- data_mutations[
substr(data_mutations$Tumor_Sample_Barcode, 1, 12) %in% common_patients,
]
# Analyze each top gene
for (gene in top_20_gene_names) {
# Get all mutations for this gene (including synonymous)
gene_mut_data <- all_mutations_common[
all_mutations_common$Hugo_Symbol == gene,
]
# Skip if no mutations
if (nrow(gene_mut_data) == 0) next
# Create mutation type classification for each patient
mutation_status <- data.frame(
PATIENT_ID = common_patients,
Mutation_Type = "None",
stringsAsFactors = FALSE
)
for (i in 1:nrow(gene_mut_data)) {
patient_id <- substr(gene_mut_data$Tumor_Sample_Barcode[i], 1, 12)
var_class <- gene_mut_data$Variant_Classification[i]
if (patient_id %in% mutation_status$PATIENT_ID) {
if (var_class %in% synonymous_types) {
mutation_status$Mutation_Type[mutation_status$PATIENT_ID == patient_id] <- "Synonymous"
} else if (var_class %in% non_synonymous_types) {
mutation_status$Mutation_Type[mutation_status$PATIENT_ID == patient_id] <- "Non-Synonymous"
}
}
}
# Merge with clinical data
merged_data <- merge(
data_clinical_patient,
mutation_status,
by = "PATIENT_ID",
all.x = FALSE
)
# Remove missing DSS data
merged_data <- merged_data[!is.na(merged_data$DSS_MONTHS) &
!is.na(merged_data$DSS_STATUS), ]
# Count each group
n_syn <- sum(merged_data$Mutation_Type == "Synonymous")
n_nonsyn <- sum(merged_data$Mutation_Type == "Non-Synonymous")
n_none <- sum(merged_data$Mutation_Type == "None")
# Skip if insufficient data in mutation groups
if (n_syn < 3 && n_nonsyn < 3) next
# Create survival object
surv_dss <- Surv(
time = merged_data$DSS_MONTHS,
event = 1 - merged_data$DSS_STATUS
)
# Determine which groups actually exist
existing_groups <- unique(merged_data$Mutation_Type)
# Create factor with only existing levels
merged_data$Mutation_Type <- factor(
merged_data$Mutation_Type,
levels = existing_groups
)
# Fit Kaplan-Meier by mutation type
fit_type <- survfit(surv_dss ~ Mutation_Type, data = merged_data)
# Log-rank test
log_rank_test <- survdiff(surv_dss ~ Mutation_Type, data = merged_data)
p_overall <- pchisq(log_rank_test$chisq,
length(log_rank_test$n) - 1,
lower.tail = FALSE)
# Store results
mutation_type_results <- rbind(mutation_type_results, data.frame(
Gene = gene,
N_Synonymous = n_syn,
N_NonSynonymous = n_nonsyn,
N_NoMutation = n_none,
P_Value_Overall = p_overall,
stringsAsFactors = FALSE
))
# Plot if significant (p < 0.05) and sufficient data
if (p_overall < 0.05 && (n_syn >= 3 || n_nonsyn >= 3)) {
# Create dynamic legend labels based on which groups exist
# Match colors to specific mutation types (not order-dependent)
legend_labels <- character()
palette_colors <- character()
if ("None" %in% existing_groups) {
legend_labels <- c(legend_labels, "No Mutation")
palette_colors <- c(palette_colors, "blue")
}
if ("Synonymous" %in% existing_groups) {
legend_labels <- c(legend_labels, "Synonymous")
palette_colors <- c(palette_colors, "orange")
}
if ("Non-Synonymous" %in% existing_groups) {
legend_labels <- c(legend_labels, "Non-Synonymous")
palette_colors <- c(palette_colors, "red")
}
plot_obj <- ggsurvplot(
fit_type,
data = merged_data,
pval = TRUE,
conf.int = FALSE,
risk.table = TRUE,
palette = palette_colors,
title = paste0("DSS by Mutation Type: ", gene),
xlab = "Time (Months)",
ylab = "Disease-Specific Survival Probability",
legend.labs = legend_labels,
ggtheme = theme_minimal(base_size = 12)
)
print(plot_obj)
}
}
# Display results
mutation_type_results <- mutation_type_results[
order(mutation_type_results$P_Value_Overall),
]
cat("\nMUTATION TYPE ANALYSIS RESULTS \n\n")
print(mutation_type_results, row.names = FALSE)
# Summary interpretation
if (nrow(mutation_type_results) == 0) {
cat("\n*** No genes had sufficient data for mutation type analysis ***\n")
cat("This occurs when genes have very few or no synonymous mutations.\n")
} else {
cat("\nINTERPRETATION \n")
cat("This analysis tests whether the FUNCTIONAL IMPACT of mutations matters.\n")
cat("- Synonymous mutations: Change DNA but NOT protein (usually harmless)\n")
cat("- Non-synonymous mutations: Change DNA AND protein (potentially damaging)\n\n")
if (any(mutation_type_results$P_Value_Overall < 0.05)) {
cat("Genes with p < 0.05 show that mutation type affects survival.\n")
cat("If non-synonymous mutations have worse outcomes, it suggests the\n")
cat("functional disruption of the protein drives disease progression.\n")
} else {
cat("No genes showed significant differences between mutation types.\n")
cat("This may indicate:\n")
cat("1. Sample sizes are too small to detect differences\n")
cat("2. Very few synonymous mutations exist in these genes\n")
cat("3. The analysis is underpowered for this comparison\n")
}
}
# Create comprehensive summary tables and figures
# --- DEMOGRAPHICS AND CLINICAL CHARACTERISTICS ---
# [INSERT CODE HERE]
# --- SURVIVAL OUTCOMES ---
# Median survival times for OS, DSS, PFS, DFS
# [INSERT CODE HERE]
# --- MUTATION ANALYSIS ---
# Top mutated genes and their frequencies
# [INSERT CODE HERE]
# --- CLUSTERING RESULTS ---
# Number of clusters, sizes, clinical associations
# [INSERT CODE HERE]
# --- GENE-GENE INTERACTIONS ---
# Significant co-mutations and mutual exclusivity
# [INSERT CODE HERE]
# --- PROGNOSTIC GENES ---
# Genes significantly associated with DSS
# [INSERT CODE HERE]
setwd("C:/Users/maxim/Desktop/BMEG 310/BMEG-310---Final-Project-P2")
